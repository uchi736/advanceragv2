# 専門用語抽出ログガイド

## 概要

専門用語抽出プロセスの各段階で詳細なログが記録されるようになりました。
これにより、どの段階でどの用語が抽出・除外されたかを追跡できます。

## ログの構造

### 1. 候補用語抽出フェーズ

```
======================================================================
候補用語抽出開始
======================================================================
[1/4] 正規表現パターン: X種類、Y個の出現
[2/4] Mode C（長単位）: X種類、Y個の出現
[3/4] Mode A + n-gram: X種類、Y個の出現
[4/4] 複合名詞: X種類、Y個の出現
抽出された候補（重複含む）: Z個
ユニークな候補用語数: W個
頻度フィルタ後（min_frequency=2）: V個
======================================================================
```

**確認ポイント**:
- **正規表現パターン**: G0, BMS, 6DE-18などの型式・略語
- **Mode C**: 自然な複合語（舶用ディーゼルエンジンなど）
- **Mode A + n-gram**: 形態素のn-gram組み合わせ
- **複合名詞**: 品詞ベースの複合名詞
- **頻度フィルタ**: `min_frequency`未満の用語が除外される

### 2. 頻度フィルタ

```
頻度フィルタで除外: N個（頻度<2）
  頻度1の除外例: 用語1, 用語2, 用語3...
```

**確認ポイント**:
- 1回しか出現しない用語が除外される
- サンプル（最大10個）が表示される

### 3. スコアリングフェーズ

```
Computing TF-IDF scores for X candidates
Computing C-value scores for X candidates
Selected top N candidates for SemReRank (from X total)
Processing all X candidates with SemReRank
```

**確認ポイント**:
- TF-IDF、C-valueの計算対象数
- SemReRankの処理対象数（上位N%に絞られる場合あり）

### 4. 軽量LLMフィルタ

```
======================================================================
ステップ7: 軽量LLMフィルタ前の状態
======================================================================
  候補用語総数: X個
  - 略語: Y個（自動承認）
  - 非略語: Z個
  略語サンプル: BMS, AVR, SFOC...

Lightweight filtering W candidates (top 50%)
Lightweight filter passed: V/W terms
  - 承認: V個
  - 除外: (W-V)個
定義生成対象: U個（略語Y個 + フィルタ通過V個）
```

**確認ポイント**:
- 略語は自動承認される
- 上位N%のみがフィルタ対象
- 軽量フィルタで一般用語が除外される

### 5. 定義生成フェーズ

```
Bulk generating definitions with RAG for X terms
Step 1/3: Parallel vector search
Step 2/3: Context preparation (X terms)
Step 3/3: Batch LLM definition generation (X terms)
Completed Y/X definitions
```

**確認ポイント**:
- ベクトル検索の並列実行
- バッチLLM処理の進捗
- 定義生成の成功数

### 6. 重量LLMフィルタ

```
======================================================================
ステップ9: 重量LLMフィルタ
======================================================================
  定義生成完了: X個
  定義なし: Y個
Filtering terms with LLM
  [OK] 用語1: 専門用語
  [NG] 用語2: 一般用語
  ...
重量LLMフィルタ結果:
  - 専門用語として承認: V個
  - 一般用語として除外: W個
最終的な専門用語数: V個
```

**確認ポイント**:
- 定義がある用語のみフィルタ対象
- 各用語の判定結果（OK/NG）
- 最終的な承認・除外数

### 7. 最終サマリー

```
======================================================================
専門用語抽出完了 - サマリー
======================================================================
最終的な専門用語数: X個
  - 定義あり: Y個
  - 定義なし: Z個
  - 略語: W個
======================================================================
```

**確認ポイント**:
- 最終的に抽出された専門用語の総数
- 定義の有無
- 略語の数

## 用語の漏れを追跡する方法

### 1. 候補抽出段階での漏れ

**確認方法**:
```
[1/4] 正規表現パターン: X種類、Y個の出現
```

**漏れの原因**:
- 正規表現パターンに該当しない
  - 例: G0 → `(?<![A-Za-z0-9])[A-Z][0-9]{1,2}(?![A-Za-z0-9])` に追加で解決
- Mode C/n-gramで拾えない複合語

**対策**:
- 正規表現パターンを追加
- `min_term_length`を調整

### 2. 頻度フィルタでの除外

**確認方法**:
```
頻度フィルタで除外: N個（頻度<2）
  頻度1の除外例: ...
```

**漏れの原因**:
- 出現頻度が`min_frequency`未満

**対策**:
- `min_frequency`を1に変更（ノイズ増加に注意）

### 3. 軽量LLMフィルタでの除外

**確認方法**:
```
Lightweight filter passed: V/W terms
  - 除外: X個
```

**漏れの原因**:
- LLMが一般用語と判定

**対策**:
- `definition_generation_percentile`を増やす（より多くの候補を処理）
- `enable_lightweight_filter`を無効化

### 4. 定義生成の失敗

**確認方法**:
```
  定義生成完了: X個
  定義なし: Y個
```

**漏れの原因**:
- ベクトル検索で関連文書が見つからない
- LLM定義生成のエラー

**対策**:
- ベクトル検索のk値を増やす
- コンテキスト長を増やす

### 5. 重量LLMフィルタでの除外

**確認方法**:
```
  [NG] 用語X: 一般用語
```

**漏れの原因**:
- LLMが専門用語でないと判定

**対策**:
- プロンプトを調整
- 重量LLMフィルタを無効化

## ログレベルの設定

### INFO レベル（デフォルト）
- 各段階のサマリー
- 抽出数、除外数
- 重要な判定結果

### DEBUG レベル
- 詳細な除外理由
- 個別用語の処理状況

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 出力例

```
INFO - ======================================================================
INFO - 候補用語抽出開始
INFO - ======================================================================
INFO - [1/4] 正規表現パターン: 17種類、87個の出現
INFO - [2/4] Mode C（長単位）: 16種類、93個の出現
INFO - [3/4] Mode A + n-gram: 56種類、279個の出現
INFO - [4/4] 複合名詞: 24種類、111個の出現
INFO - 抽出された候補（重複含む）: 294個
INFO - ユニークな候補用語数: 61個
INFO - 頻度フィルタ後（min_frequency=2）: 61個
INFO - ======================================================================
```

## トラブルシューティング

### Q: G0が抽出されない

**ログ確認**:
```
[1/4] 正規表現パターン: X種類、Y個の出現
```
→ G0が含まれているか確認

**対策**: 正規表現パターンに追加済み

### Q: 頻度が高いのに除外される

**ログ確認**:
```
Lightweight filter passed: V/W terms
  - 除外: X個
```

**対策**: `definition_generation_percentile`を増やす

### Q: 定義が生成されない

**ログ確認**:
```
  定義生成完了: X個
  定義なし: Y個
```

**対策**: ベクトル検索のパラメータ調整
