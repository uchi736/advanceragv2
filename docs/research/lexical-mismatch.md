# 語彙ギャップ（Lexical Mismatch）対策 検証チェックリスト

本ドキュメントは、クエリが日常語でドキュメント側が専門用語を含む場合の検索品質を改善するための検証項目案です。提案済みの手法（ドキュメント拡張、用語定義ANN、タグ付け、ハイブリッド検索、再ランク等）を含め、段階的に品質・性能を確認します。

---

## 目的と前提
- [ ] 目的: 日常語クエリに対して、専門用語で書かれた関連チャンクの再現率・順位を改善する。
- [ ] 対象: 既存のRAG検索パイプライン（BM25/ベクトルのハイブリッド前提）。
- [ ] 辞書: `output/terms_100.json`（`headword`, `synonyms`, `definition`）を一次ソースとする。
- [ ] 評価分割: ベースライン→機能追加の漸進（アブレーションで寄与を特定）。

---

## 対策案（実装オプション）
- [ ] ドキュメント拡張（インデックス拡張）: チャンクに含まれる専門用語の定義・別名・日常語言い換えを検索用の影フィールドへ付与。
- [ ] 用語タグ付け＋ブースト: チャンクに `terms:[用語ID...]` を付与し、クエリから推定した用語ID一致を強ブースト。
- [ ] 用語定義ベクトル索引（ANN）: `terms_100.json` 各エントリを1ベクトルとして索引。クエリから上位k用語のみ選抜して拡張・ブーストに用いる。
- [ ] クエリ拡張: 辞書・LLMで日常語→専門語の追加（OR拡張）や書き換えを実施（安全枠内・上限語数あり）。
- [ ] Doc2Query/SPLADE的拡張: チャンクから日常語パラフレーズを生成し索引用に追加（過度な水増しは抑制）。
- [ ] ハイブリッド検索: BM25（raw+影フィールド）× ベクトル（raw+短縮定義）融合。最終段でクロスエンコーダ再ランク。
- [ ] 正規化: 表記揺れ（全角/半角、ハイフン/スペース、英略語/和名）を正規化し辞書正規形に紐付け。

---

## 評価設計
### オフライン品質
- [ ] データセット作成: 日常語クエリと期待チャンク（専門語含む）対応のゴールド作成。
  - [ ] 既存ログやFAQを起点に、日常語→専門語のアノテーションを付与。
  - [ ] 分野バランス（医療/法律/製造 等）・難易度（初学/中級/専門）で層化。
- [ ] メトリクス: Recall@k, nDCG@k, Precision@k, MRR@k（k=10推奨）。
- [ ] 目標例: 日常語サブセットの Recall@10 +10〜20% 改善、nDCG@10 有意向上（p<0.05）。
- [ ] アブレーション: ベースライン → +ドキュメント拡張 → +用語ANN → +タグブースト → +再ランクの順に寄与を測定。
- [ ] ノイズ評価: 誤マッチ率、冗長ヒット（定義だけで本文が不適）の割合を計測。

### オンライン/性能
- [ ] レイテンシ: p50/p95 の増分（目安: +20%以内）。
- [ ] コスト: インデックスサイズ増分（影フィールド含め +40%以内目標）、ANNのメモリ/CPU。
- [ ] 安定性: タイムアウト・エラー率・スロットリング挙動。
- [ ] キャッシュ: 用語ANN（小規模）のクエリキャッシュ有無で差分確認。

---

## 検証シナリオ（チェックリスト）
### S0: ベースライン把握
- [ ] 現行パイプラインの Recall@10 / nDCG@10（全体・日常語サブセット）を算出。
- [ ] 代表クエリ10〜30件で上位結果を目視評価（関連/部分一致/不一致）。

### S1: ドキュメント拡張（影フィールド）
- [ ] 1用語あたり追加テキストを「短縮定義（1文/最大120字）」に制限。
- [ ] 追加対象: `headword` と `synonyms` の一致検出時のみ。多重一致は重複排除。
- [ ] 検索時: 影フィールドはBM25で低ブースト（例: 0.3〜0.6）。
- [ ] 評価: 品質メトリクスと誤マッチ率の変化を測定。

### S2: 用語定義ANN → 上位k用語のクエリ拡張
- [ ] 索引: `headword | synonyms | definition(短縮)` を1エンベディング／用語。
- [ ] クエリ: ANNで上位k=5〜20件を取得、スコア閾値で刈り込み。
- [ ] 拡張: 選抜用語の `headword/synonyms` をOR追加、対応チャンクの `terms` 一致をブースト。
- [ ] 評価: ベースライン比の改善と、過剰拡張（ノイズ）の監視。

### S3: 用語タグ付け＋ブースト
- [ ] 前処理でチャンクに `terms:[用語ID...]` を付与（正規化後の一致に限る）。
- [ ] 検索時、S2で推定した用語IDと一致するチャンクを強ブースト（例: 2.0〜4.0）。
- [ ] 評価: 上位ヒットに「本文側に用語・近接説明が存在する」割合を確認。

### S4: 再ランク（クロスエンコーダ）
- [ ] 対象: 上位50〜200件。
- [ ] 入力: クエリ + チャンク + （該当用語の短い定義を1文追加）。
- [ ] 評価: nDCG/MRRの改善、レイテンシ影響、再現性（種固定）。

### S5: 正規化・表記揺れ
- [ ] ルール: 大文字/小文字、全半角、記号、スペース、和英揺れ（例: アンモニア/Ammonia）。
- [ ] 辞書: 略称・製品型式（例: `6L28ADF`）の検出・正規形付与。
- [ ] 評価: 揺れを含むクエリでのRecall改善を個別に確認。

---

## ガードレール/劣化検知
- [ ] 影フィールド長の上限（用語毎/チャンク毎）。
- [ ] 用語拡張の上限語数（例: 10）とスコア閾値。
- [ ] 近接制約: 影フィールド一致のみで高順位に上がらないよう、本文一致・タグ一致を加味。
- [ ] 負例セット: 似て非なる語（例: 「心痛」vs「胸痛」）で誤ヒットを監視。
- [ ] デグレ監視: トレンドダッシュボードに日常語サブセットのnDCG@10を常時表示。

---

## ログ/計測（実装確認）
- [ ] クエリごとの拡張ログ: 選抜された用語ID、追加語、ブースト係数。
- [ ] 候補生成内訳: BM25スコア、ベクトル距離、タグ一致有無、再ランクスコア。
- [ ] インデックス統計: 文書数、トークン数、影フィールド増分。
- [ ] レイテンシ分解: 前処理、ANN、BM25、再ランクの各所要時間。

---

## スキーマ/設定の検証
- [ ] フィールド設計: `text_raw`（表示用）, `text_idx`（検索用: raw+短縮定義等）, `terms`（ID配列）, `aliases`（略称/別名）, `weight`（重要度）。
- [ ] ブースト例: `BM25(text_raw)=1.0`, `BM25(text_idx)=0.4`, `terms_match=3.0`, `vector=1.0`（要チューニング）。
- [ ] ANN設定: 上位k、距離種別、圧縮有無、キャッシュ戦略。
- [ ] 正規化/トークナイズ: 日本語形態素（MeCab/Sudachi等）と英数字正規化の一貫性。

---

## 想定テストクエリ例（抜粋）
- 医療系（一般→専門）
  - [ ] 「お腹が痛い」→ 「腹痛」「腹部痛」含むチャンク（原因・対処）
  - [ ] 「心臓発作の前兆」→ 「心筋梗塞」「急性冠症候群」
- 産業/製造（一般→型式名・専門語）
  - [ ] 「アンモニア対応の船舶用エンジン」→ 「6L28ADF」「アンモニア燃料対応 レシプロエンジン」
  - [ ] 「IHIのアンモニアエンジン」→ 「6L28ADF」定義・仕様を含むチャンク
- 法律/契約
  - [ ] 「クーリングオフできる？」→ 「特定商取引法」関連チャンク
- 負例（誤ヒット抑制）
  - [ ] 「胃が痛い（胃炎）」で「心筋梗塞」過剰ヒットが増えないこと
  - [ ] 「アンモニアタンク清掃」で「エンジン型式」ばかり上位化しないこと

---

## スモークテスト（E2E）
- [ ] フラグON/OFFで各機能を独立検証（expansion, term_ann, term_boost, rerank）。
- [ ] テストクエリ10件で、上位5件のスクリーンショット/ログを保存。
- [ ] 期待する専門用語を本文が含むか（影フィールドだけでないか）を確認。

---

## 推奨の最小導入ステップ（PoC）
- [ ] 文書側拡張（短縮定義＋別名）＋用語タグ付けを前処理で実装。
- [ ] 小規模な用語定義ANNを追加し、クエリ時に上位k用語のみ採用。
- [ ] 既存ハイブリッド検索に軽量な再ランクを追加（必要に応じて）。
- [ ] 上記のアブレーションを回し、品質/レイテンシ/コストのバランス点を決定。

---

## 付記
- `output/terms_100.json` の `definition` はそのまま貼るのではなく、検索用に1文へ短縮・一般語を混ぜると効果が安定します。
- 製品型式や略称（例: `6L28ADF`）は、本文中の近接説明（例: 「アンモニア燃料対応のIHI製舶用レシプロエンジン」）があるチャンクを優先するルールを設けると精度が上がります。

